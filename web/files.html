<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPSTREAM | Files</title>
    <script src="//unpkg.com/alpinejs" defer></script>
    <script src="//unpkg.com/@tailwindcss/browser@4"></script>
    <style type="text/tailwindcss">
        @theme {
            --color-clifford: #da373d;
        }
    </style>
</head>
<body class="bg-slate-950/95 font-sans leading-relaxed tracking-normal text-slate-100">
<div class="min-h-screen bg-grid-slate-900/[0.2]">
    <div class="mx-auto max-w-5xl px-6 py-12" x-data="fileListApp()" x-init="init()">
        <div class="relative overflow-hidden rounded-3xl bg-gradient-to-r from-emerald-500 via-blue-500 to-purple-600 p-[1px] shadow-xl shadow-emerald-500/20 mb-10">
            <div class="relative rounded-3xl bg-slate-950/90 p-8">
                <div class="flex flex-col gap-6 lg:flex-row lg:justify-between">
                    <div>
                        <p class="text-sm uppercase tracking-[0.35em] text-emerald-300/80">Upstream Storage</p>
                        <h1 class="mt-2 text-3xl sm:text-2xl font-black text-white drop-shadow-sm">Stored Files Overview</h1>
                        <p class="mt-3 max-w-xl text-sm text-slate-300">
                            Review every file stored in the system with image previews for faster discovery.
                        </p>
                    </div>
                    <div class="flex flex-col items-start gap-3 lg:items-end">
                        <button
                                @click="loadFiles"
                                class="inline-flex items-center gap-2 rounded-full border border-emerald-300/40 bg-emerald-400/10 px-5 py-2 text-sm font-semibold text-emerald-100 transition hover:border-emerald-200 hover:bg-emerald-400/20"
                                :disabled="isLoading"
                                :class="isLoading ? 'opacity-60 cursor-not-allowed' : ''"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                      d="M4 4v5h.582M20 20v-5h-.581M5.418 9A7 7 0 0119 12.345M18.582 15A7 7 0 015 11.655"/>
                            </svg>
                            <span x-text="isLoading ? 'Refreshing...' : 'Refresh list'"></span>
                        </button>
                        <a href="/"
                           class="inline-flex items-center gap-2 text-xs font-medium text-slate-200 transition hover:text-white">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                      d="M15 19l-7-7 7-7"/>
                            </svg>
                            Back to upload
                        </a>
                    </div>
                </div>

                <div class="mt-6 grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
                    <div class="rounded-2xl border border-slate-800 bg-slate-900/80 px-4 py-3">
                        <p class="text-xs uppercase tracking-widest text-slate-400">Total files</p>
                        <p class="mt-2 text-2xl font-semibold text-white" x-text="files.length"></p>
                    </div>
                    <div class="rounded-2xl border border-slate-800 bg-slate-900/80 px-4 py-3">
                        <p class="text-xs uppercase tracking-widest text-slate-400">Images</p>
                        <p class="mt-2 text-2xl font-semibold text-white" x-text="countByType('image/')"></p>
                    </div>
                    <div class="rounded-2xl border border-slate-800 bg-slate-900/80 px-4 py-3">
                        <p class="text-xs uppercase tracking-widest text-slate-400">Documents</p>
                        <p class="mt-2 text-2xl font-semibold text-white" x-text="countByExt(['pdf','doc','docx','xls','xlsx'])"></p>
                    </div>
                    <div class="rounded-2xl border border-slate-800 bg-slate-900/80 px-4 py-3">
                        <p class="text-xs uppercase tracking-widest text-slate-400">Last updated</p>
                        <p class="mt-2 text-sm font-semibold text-emerald-200" x-text="formatDate(lastUpdated) || '—'"></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="rounded-3xl border border-slate-800 bg-slate-950/70 shadow-xl shadow-blue-500/10">
            <div class="border-b border-slate-800 px-6 py-4">
                <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                    <div class="flex items-center gap-3">
                        <div class="flex h-10 w-10 items-center justify-center rounded-2xl border border-blue-400/40 bg-blue-400/10 text-blue-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                      d="M3 7l8.89 5.26a2 2 0 002.22 0L23 7M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-lg font-semibold text-white">File Library</h2>
                            <p class="text-xs text-slate-400">See complete file details along with download links.</p>
                        </div>
                    </div>
                    <div class="relative w-full md:w-72">
                        <input
                                x-model="search"
                                type="search"
                                placeholder="Search files..."
                                class="w-full rounded-full border border-slate-700 bg-slate-900/60 px-4 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-400/40"
                        >
                        <svg xmlns="http://www.w3.org/2000/svg" class="absolute right-3 top-1/2 h-4 w-4 -translate-y-1/2 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                  d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 100-15 7.5 7.5 0 000 15z"/>
                        </svg>
                    </div>
                </div>
            </div>

            <template x-if="isLoading">
                <div class="flex items-center gap-3 px-6 py-8 text-sm text-slate-400">
                    <span class="inline-flex h-3 w-3 animate-ping rounded-full bg-emerald-300"></span>
                    Loading files...
                </div>
            </template>

            <template x-if="!isLoading && loadError">
                <div class="px-6 py-8 text-sm text-red-400" x-text="loadError"></div>
            </template>

            <template x-if="!isLoading && !loadError && filteredFiles.length === 0">
                <div class="px-6 py-10 text-center text-sm text-slate-400">
                    <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-2xl border border-slate-700 bg-slate-900/70">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                  d="M3 7l8.89 5.26a2 2 0 002.22 0L23 7M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                    </div>
                    <p class="mt-4 font-semibold text-slate-200">No files found</p>
                    <p class="mt-1 text-xs text-slate-500">Try uploading a file or searching with different keywords.</p>
                </div>
            </template>

            <div x-show="!isLoading && !loadError && filteredFiles.length > 0" class="grid gap-4 px-6 py-6 md:grid-cols-2">
                <template x-for="file in filteredFiles" :key="file.url">
                    <div class="group relative overflow-hidden rounded-3xl border border-slate-800 bg-slate-900/70 p-4 transition hover:border-emerald-400/40 hover:bg-slate-900/90 hover:shadow-lg hover:shadow-emerald-500/10">
                        <div class="flex items-center gap-4">
                            <template x-if="isImage(file)">
                                <div class="relative">
                                    <img
                                            :src="file.url"
                                            :alt="file.name"
                                            class="h-20 w-20 rounded-2xl border border-slate-800 object-cover transition duration-300 group-hover:scale-[1.03]"
                                    >
                                    <span class="absolute right-1 top-1 rounded-full bg-emerald-500/80 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide text-emerald-950">Preview</span>
                                </div>
                            </template>
                            <template x-if="!isImage(file)">
                                <div class="flex h-20 w-20 items-center justify-center rounded-2xl border border-slate-700 bg-slate-800/60 text-blue-200">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-9 w-9" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.3"
                                              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                </div>
                            </template>

                            <div class="min-w-0 flex-1">
                                <div class="flex items-start justify-between gap-2">
                                    <div>
                                        <a :href="file.url" target="_blank" rel="noopener"
                                           class="line-clamp-1 text-sm font-semibold text-white transition hover:text-emerald-200"
                                           x-text="file.name"></a>
                                        <p class="mt-1 text-xs text-slate-400">
                                            <span x-text="formatFileSize(Number(file.size || 0))"></span>
                                            <span class="mx-1">•</span>
                                            <span x-text="formatDate(file.upload_date)"></span>
                                        </p>
                                        <p class="mt-1 text-[11px] uppercase tracking-[0.25em] text-slate-500" x-text="file.type || 'UNKNOWN'"></p>
                                    </div>
                                    <a :href="file.url" target="_blank" rel="noopener"
                                       class="inline-flex items-center gap-1 rounded-full border border-emerald-400/30 bg-emerald-500/10 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-emerald-100 transition hover:border-emerald-300 hover:text-emerald-50">
                                        Open
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                                  d="M13 7h6m0 0v6m0-6l-8 8"/>
                                        </svg>
                                    </a>
                                </div>
                                <div class="mt-3 flex items-center gap-2 text-[11px] text-slate-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.3"
                                              d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    <span x-text="formatRelativeTime(file.upload_date)"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>
</div>

<script>
    function fileListApp() {
        return {
            files: [],
            filteredFiles: [],
            isLoading: false,
            loadError: '',
            search: '',
            lastUpdated: '',

            init() {
                this.$watch('search', () => this.filterFiles());
                this.loadFiles();
            },

            async loadFiles() {
                this.isLoading = true;
                this.loadError = '';

                try {
                    const response = await fetch('/file');
                    if (!response.ok) {
                        throw new Error('Failed to fetch files');
                    }

                    const payload = await response.json();
                    this.files = Array.isArray(payload.data) ? payload.data : [];
                    this.lastUpdated = new Date().toISOString();
                    this.filterFiles();
                } catch (error) {
                    console.error('Unable to load files', error);
                    this.loadError = 'Unable to load file list.';
                    this.files = [];
                    this.filteredFiles = [];
                } finally {
                    this.isLoading = false;
                }
            },

            formatFileSize(bytes) {
                if (!Number.isFinite(bytes) || bytes <= 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return `${parseFloat((bytes / Math.pow(k, i)).toFixed(1))} ${sizes[i]}`;
            },

            formatDate(value) {
                if (!value) return '';
                const date = new Date(value);
                if (Number.isNaN(date.getTime())) {
                    return value;
                }
                return date.toLocaleString();
            },

            formatRelativeTime(value) {
                if (!value) return '';
                const date = new Date(value);
                if (Number.isNaN(date.getTime())) return '';
                const diff = Date.now() - date.getTime();
                const minute = 60 * 1000;
                const hour = 60 * minute;
                const day = 24 * hour;
                if (diff < minute) return 'Just now';
                if (diff < hour) return `${Math.round(diff / minute)} minutes ago`;
                if (diff < day) return `${Math.round(diff / hour)} hours ago`;
                return `${Math.round(diff / day)} days ago`;
            },

            isImage(file) {
                return (file.type || '').includes('image');
            },

            filterFiles() {
                const term = this.search.trim().toLowerCase();
                this.filteredFiles = term.length === 0
                    ? [...this.files]
                    : this.files.filter((file) => {
                        const name = (file.name || '').toLowerCase();
                        const type = (file.type || '').toLowerCase();
                        return name.includes(term) || type.includes(term);
                    });
            },

            countByType(prefix) {
                return this.files.filter((file) => (file.type || '').startsWith(prefix)).length;
            },

            countByExt(exts) {
                return this.files.filter((file) => {
                    const ext = (file.name || '').split('.').pop()?.toLowerCase();
                    return exts.includes(ext || '');
                }).length;
            }
        };
    }
</script>
</body>
</html>
