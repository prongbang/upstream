<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPSTREAM | Upload</title>
    <script src="//unpkg.com/alpinejs" defer></script>
    <script src="//unpkg.com/@tailwindcss/browser@4"></script>
    <style type="text/tailwindcss">
        @theme {
            --color-clifford: #da373d;
        }
    </style>
</head>
<body class="bg-slate-950/95 font-sans leading-relaxed tracking-normal text-slate-100">
<div class="min-h-screen bg-grid-slate-900/[0.2]">
    <div class="mx-auto max-w-5xl px-4 py-10 sm:px-6 sm:py-12" x-data="uploadApp()">
        <div class="relative overflow-hidden rounded-3xl bg-gradient-to-r from-green-500 via-blue-500 to-purple-600 p-[1px] shadow-xl shadow-green-500/20">
            <div class="relative rounded-3xl bg-slate-950/90 p-6 sm:p-8">
                <div class="flex flex-col gap-5 lg:flex-row lg:justify-between lg:gap-8">
                    <div>
                        <p class="text-sm uppercase tracking-[0.4em] text-green-200/80">Upstream Uploader</p>
                        <h1 class="mt-2 text-3xl font-black text-white drop-shadow-sm sm:text-2xl">Upload &amp; manage your files</h1>
                        <p class="mt-3 max-w-xl text-sm text-slate-300 sm:text-base">
                            Drag files or browse from your device and monitor real-time upload progress.
                        </p>
                    </div>
                    <div class="flex flex-col items-start gap-4 lg:items-end">
                        <a href="/files"
                           class="inline-flex w-full items-center justify-center gap-2 rounded-full border border-blue-300/40 bg-blue-400/10 px-5 py-2 text-sm font-semibold text-blue-100 transition hover:border-blue-200 hover:bg-blue-400/20 sm:w-auto">
                            View stored files
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                 stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                      d="M9 5l7 7-7 7"/>
                            </svg>
                        </a>
                        <div class="hidden w-full rounded-2xl border border-slate-800 bg-slate-900/70 px-4 py-3 text-right sm:block">
                            <p class="text-xs uppercase tracking-[0.25em] text-slate-500">Queued files</p>
                            <p class="mt-2 text-2xl font-semibold text-white" x-text="files.length"></p>
                        </div>
                    </div>
                </div>

                <div class="mt-6 grid grid-cols-2 gap-2 sm:hidden">
                    <div class="col-span-2 rounded-2xl border border-slate-800 bg-slate-900/80 px-3 py-3 text-center">
                        <span class="block text-[10px] uppercase tracking-[0.35em] text-slate-500">Queued files</span>
                        <span class="mt-1 text-lg font-semibold text-white" x-text="files.length"></span>
                    </div>
                    <div class="rounded-2xl border border-slate-800 bg-slate-900/80 px-3 py-2 text-center">
                        <span class="block text-[10px] uppercase tracking-[0.3em] text-slate-500">Total size</span>
                        <span class="mt-1 text-sm font-semibold text-white" x-text="formatFileSize(totalSize())"></span>
                    </div>
                    <div class="rounded-2xl border border-slate-800 bg-slate-900/80 px-3 py-2 text-center">
                        <span class="block text-[10px] uppercase tracking-[0.3em] text-slate-500">Active uploads</span>
                        <span class="mt-1 text-sm font-semibold text-white" x-text="activeUploads()"></span>
                    </div>
                    <div class="rounded-2xl border border-slate-800 bg-slate-900/80 px-3 py-2 text-center">
                        <span class="block text-[10px] uppercase tracking-[0.3em] text-slate-500">Completed</span>
                        <span class="mt-1 text-sm font-semibold text-white" x-text="completedUploads()"></span>
                    </div>
                    <div class="rounded-2xl border border-slate-800 bg-slate-900/80 px-3 py-2 text-center">
                        <span class="block text-[10px] uppercase tracking-[0.3em] text-slate-500">Status</span>
                        <span class="mt-1 text-sm font-semibold" :class="isUploading ? 'text-amber-300' : 'text-emerald-300'"
                              x-text="isUploading ? 'Uploading' : 'Idle'"></span>
                    </div>
                </div>

                <div class="mt-6 hidden gap-4 sm:grid sm:grid-cols-2 lg:grid-cols-4">
                    <div class="rounded-2xl border border-slate-800 bg-slate-900/80 px-4 py-3 text-center sm:text-left">
                        <p class="text-xs uppercase tracking-widest text-slate-400">Total size</p>
                        <p class="mt-2 text-lg font-semibold text-white" x-text="formatFileSize(totalSize())"></p>
                    </div>
                    <div class="rounded-2xl border border-slate-800 bg-slate-900/80 px-4 py-3 text-center sm:text-left">
                        <p class="text-xs uppercase tracking-widest text-slate-400">Active uploads</p>
                        <p class="mt-2 text-lg font-semibold text-white" x-text="activeUploads()"></p>
                    </div>
                    <div class="rounded-2xl border border-slate-800 bg-slate-900/80 px-4 py-3 text-center sm:text-left">
                        <p class="text-xs uppercase tracking-widest text-slate-400">Completed</p>
                        <p class="mt-2 text-lg font-semibold text-white" x-text="completedUploads()"></p>
                    </div>
                    <div class="rounded-2xl border border-slate-800 bg-slate-900/80 px-4 py-3 text-center sm:text-left">
                        <p class="text-xs uppercase tracking-widest text-slate-400">Status</p>
                        <p class="mt-2 text-sm font-semibold" :class="isUploading ? 'text-amber-300' : 'text-emerald-300'"
                           x-text="isUploading ? 'Uploading...' : 'Idle'"></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-8 grid gap-6 lg:grid-cols-[minmax(0,1fr)]">
            <div class="rounded-3xl border border-dashed border-slate-700/80 bg-slate-950/70 p-5 transition duration-300 sm:p-8"
                 :class="isDragging ? 'border-emerald-400 bg-emerald-500/10 shadow-emerald-500/10' : 'hover:border-slate-500/80 hover:bg-slate-900/60'">
                <div
                        class="flex flex-col items-center justify-center text-center"
                        @dragover.prevent="isDragging = true"
                        @dragleave.prevent="isDragging = false"
                        @drop.prevent="handleDrop"
                >
                    <div class="mb-5 inline-flex h-16 w-16 items-center justify-center rounded-2xl border border-emerald-300/40 bg-emerald-400/10 text-emerald-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                  d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                    </div>
                    <h2 class="text-xl font-semibold text-white">Drop your files here</h2>
                    <p class="mt-2 max-w-lg text-sm text-slate-400">Supported up to 100 GB per batch. Simply drag files or click to choose them from your device.</p>
                    <div class="mt-5 flex w-full flex-col items-center justify-center gap-2 sm:flex-row sm:flex-wrap sm:gap-3">
                        <button
                                type="button"
                                @click="$refs.fileInput.click()"
                                class="inline-flex w-full items-center justify-center gap-2 rounded-full bg-emerald-500 px-5 py-2 text-sm font-semibold text-emerald-950 transition hover:bg-emerald-400 sm:w-auto">
                            Choose files
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                      d="M12 4v16m8-8H4"/>
                            </svg>
                        </button>
                        <span class="text-xs uppercase tracking-[0.3em] text-slate-500">or drag and drop</span>
                    </div>
                    <input type="file" x-ref="fileInput" @change="handleFileSelect" multiple class="hidden">
                </div>
            </div>

            <div class="rounded-3xl border border-slate-800 bg-slate-950/70 shadow-xl shadow-blue-500/10">
                <div class="flex flex-col gap-4 border-b border-slate-800 px-4 py-4 sm:px-6 sm:py-5 md:flex-row md:items-center md:justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-white">Upload queue</h3>
                        <p class="text-xs text-slate-400">Track the progress of files that are uploading.</p>
                    </div>
                    <div class="flex flex-col gap-2 sm:flex-row sm:flex-wrap sm:items-center">
                        <button
                                @click="uploadFiles"
                                class="inline-flex items-center justify-center gap-2 rounded-full px-4 py-2 text-sm font-semibold transition focus:outline-none focus:ring-2 focus:ring-emerald-400/40 focus:ring-offset-2 focus:ring-offset-slate-950"
                                :disabled="isUploading || files.length === 0"
                                :class="(isUploading || files.length === 0)
                                    ? 'cursor-not-allowed border border-slate-700 bg-slate-800/70 text-slate-400'
                                    : 'border border-transparent bg-gradient-to-r from-emerald-400 via-blue-400 to-purple-500 text-slate-950 shadow-lg shadow-emerald-500/20 hover:from-emerald-300 hover:via-blue-300 hover:to-purple-400 hover:shadow-emerald-400/30'"
                        >
                            <template x-if="isUploading">
                                <svg class="h-4 w-4 animate-spin text-slate-100" viewBox="0 0 24 24" fill="none">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                                </svg>
                            </template>
                            <template x-if="!isUploading">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                          d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5-6 5 6M12 4v12"/>
                                </svg>
                            </template>
                            <span x-text="isUploading ? 'Uploading...' : 'Upload all'"></span>
                        </button>
                        <button
                                @click="clearQueue"
                                class="inline-flex items-center justify-center gap-2 rounded-full border border-slate-700 bg-slate-900/80 px-4 py-2 text-sm font-semibold text-slate-200 transition hover:border-red-400/40 hover:bg-red-500/10 hover:text-red-200"
                                :disabled="files.length === 0 || isUploading"
                                :class="(files.length === 0 || isUploading) ? 'opacity-60 cursor-not-allowed' : ''"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                      d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            Clear queue
                        </button>
                    </div>
                </div>

                <template x-if="files.length === 0">
                    <div class="px-4 py-8 text-center text-sm text-slate-400 sm:px-6 sm:py-10">
                        <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-2xl border border-slate-700 bg-slate-900/70 mb-3 sm:mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                      d="M8 7h10M8 11h6m-6 4h6M5 7h.01M5 11h.01M5 15h.01M9 19h6a2 2 0 002-2V7a2 2 0 00-2-2H9"/>
                            </svg>
                        </div>
                        <p class="mt-4 font-semibold text-slate-200">Your queue is empty</p>
                        <p class="mt-1 text-xs text-slate-500">Add files to the queue using the panel above.</p>
                    </div>
                </template>

                <div x-show="files.length > 0" class="space-y-3 px-4 py-5 sm:px-6 sm:py-6">
                    <template x-for="(file, index) in files" :key="index">
                        <div class="group relative overflow-hidden rounded-2xl border border-slate-800 bg-slate-900/70 p-4 transition hover:border-emerald-400/40 hover:bg-slate-900/90">
                            <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:gap-4">
                                <div class="flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-xl border border-slate-700 bg-slate-800/70 text-blue-200 sm:h-12 sm:w-12">
                                    <template x-if="file.type.includes('image')">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                                  d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                        </svg>
                                    </template>
                                    <template x-if="!file.type.includes('image')">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                                  d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                        </svg>
                                    </template>
                                </div>
                                <div class="min-w-0 flex-1">
                                    <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
                                        <div class="min-w-0">
                                            <p class="text-sm font-semibold text-white line-clamp-1 sm:text-base" x-text="file.name"></p>
                                            <p class="mt-1 text-xs text-slate-400 sm:text-sm">
                                                <span x-text="formatFileSize(file.size)"></span>
                                                <template x-if="file.progress > 0">
                                                    <span>
                                                        <span class="mx-1 text-slate-600">•</span>
                                                        <span x-text="file.progress + '%'"></span>
                                                    </span>
                                                </template>
                                            </p>
                                        </div>
                                        <div class="flex flex-wrap items-center gap-2">
                                            <template x-if="file.progress === 100">
                                                <span class="inline-flex items-center gap-1 rounded-full bg-emerald-500/10 px-3 py-1 text-xs font-semibold text-emerald-200">
                                                    <span class="h-2 w-2 rounded-full bg-emerald-300"></span>
                                                    Completed
                                                </span>
                                            </template>
                                            <template x-if="file.progress > 0 && file.progress < 100">
                                                <span class="inline-flex items-center gap-1 rounded-full bg-blue-500/10 px-3 py-1 text-xs font-semibold text-blue-200">
                                                    <span class="h-2 w-2 animate-ping rounded-full bg-blue-300"></span>
                                                    Uploading
                                                </span>
                                            </template>
                                            <button
                                                    @click="removeFile(index)"
                                                    class="inline-flex h-7 w-7 items-center justify-center rounded-full border border-slate-700 text-slate-400 transition hover:border-red-400 hover:text-red-300">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                                          d="M6 18L18 6M6 6l12 12"/>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                    <template x-if="file.progress > 0 && file.progress < 100">
                                        <div class="mt-2 flex flex-col gap-1 text-[11px] text-slate-500 sm:flex-row sm:items-center sm:justify-between">
                                            <span x-text="formatSpeed(file.speed) + '/s'"></span>
                                            <span x-text="file.progress + '% complete'"></span>
                                        </div>
                                    </template>
                                    <div x-show="file.progress > 0" class="mt-3 h-1.5 rounded-full bg-slate-800">
                                        <div class="h-full rounded-full bg-gradient-to-r from-emerald-400 via-blue-400 to-purple-500 transition-all duration-300"
                                             :style="'width: ' + file.progress + '%'"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <div
                x-show="showNotification"
                x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0 transform translate-y-2"
                x-transition:enter-end="opacity-100 transform translate-y-0"
                x-transition:leave="transition ease-in duration-300"
                x-transition:leave-start="opacity-100 transform translate-y-0"
                x-transition:leave-end="opacity-0 transform translate-y-2"
                class="fixed bottom-6 left-4 right-4 inline-flex items-center gap-3 rounded-2xl border border-emerald-400/40 bg-emerald-500/15 px-4 py-3 text-sm font-semibold text-emerald-100 shadow-lg shadow-emerald-500/20 sm:left-auto sm:right-6 sm:px-5"
        >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 13l4 4L19 7"/>
            </svg>
            Files uploaded successfully!
        </div>
    </div>
</div>

<script>
    function uploadApp() {
        return {
            isDragging: false,
            isUploading: false,
            showNotification: false,
            files: [],

            totalSize() {
                return this.files.reduce((total, file) => total + (file.size || 0), 0);
            },

            activeUploads() {
                return this.files.filter(file => file.progress > 0 && file.progress < 100).length;
            },

            completedUploads() {
                return this.files.filter(file => file.progress === 100).length;
            },

            // Handle drag and drop
            handleDrop(e) {
                this.isDragging = false;
                const droppedFiles = e.dataTransfer.files;
                this.addFiles(droppedFiles);
            },

            // Handle file input select
            handleFileSelect() {
                const selectedFiles = this.$refs.fileInput.files;
                this.addFiles(selectedFiles);
            },

            // Add files to the queue
            addFiles(fileList) {
                const newFiles = Array.from(fileList).map(file => ({
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    file: file,
                    progress: 0,
                    speed: 0,
                    uploaded: false
                }));

                this.files = [...this.files, ...newFiles];
            },

            // Remove file from queue
            removeFile(index) {
                this.files.splice(index, 1);
            },

            clearQueue() {
                if (this.isUploading) return;
                this.files = [];
                this.showNotification = false;
            },

            // Format file size
            formatFileSize(bytes) {
                if (!Number.isFinite(bytes) || bytes <= 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return `${parseFloat((bytes / Math.pow(k, i)).toFixed(1))} ${sizes[i]}`;
            },

            // Format speed
            formatSpeed(bytesPerSecond) {
                if (!Number.isFinite(bytesPerSecond) || bytesPerSecond <= 0) return '0 Bytes';
                return this.formatFileSize(bytesPerSecond);
            },

            // Upload files
            uploadFiles() {
                if (this.files.length === 0 || this.isUploading) return;

                const pendingFiles = this.files.filter(file => file.progress < 100);
                if (pendingFiles.length === 0) {
                    this.isUploading = false;
                    this.showNotification = true;
                    setTimeout(() => {
                        this.showNotification = false;
                    }, 3000);
                    return;
                }

                this.isUploading = true;

                pendingFiles.forEach((fileObj) => {
                    if (fileObj.progress === 100) return;

                    const formData = new FormData();
                    formData.append('file', fileObj.file);

                    const xhr = new XMLHttpRequest();
                    let startTime = new Date().getTime();
                    let loadedPrev = 0;

                    // Progress event listener
                    xhr.upload.onprogress = (event) => {
                        if (event.lengthComputable) {
                            // Calculate progress
                            fileObj.progress = Math.round((event.loaded / event.total) * 100);

                            // Calculate speed
                            const currentTime = new Date().getTime();
                            const elapsedTime = (currentTime - startTime) / 1000; // seconds
                            if (elapsedTime > 0) {
                                const loadedDelta = event.loaded - loadedPrev;
                                fileObj.speed = Math.round(loadedDelta / elapsedTime);
                                startTime = currentTime;
                                loadedPrev = event.loaded;
                            }
                        }
                    };

                    // On upload complete
                    xhr.onload = () => {
                        if (xhr.status === 200) {
                            fileObj.progress = 100;
                            fileObj.uploaded = true;

                            // Check if all files have been uploaded
                            this.checkUploadCompletion();
                        } else {
                            console.error('Upload failed:', xhr.statusText);
                        }
                    };

                    xhr.onerror = () => {
                        console.error('An error occurred during the upload.');
                    };

                    xhr.open('POST', '/up', true);
                    xhr.send(formData);
                });
            },

            // Check if all files have been uploaded
            checkUploadCompletion() {
                if (this.files.every(file => file.progress === 100)) {
                    this.isUploading = false;
                    this.showNotification = true;

                    // Hide notification after 3 seconds
                    setTimeout(() => {
                        this.showNotification = false;
                    }, 3000);
                }
            }
        };
    }
</script>
</body>
</html>
